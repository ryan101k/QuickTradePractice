<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>단타 주식 연습</title>
  <link rel="stylesheet" href="https://unpkg.com/98.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 0;
      background-color: #008080; /* Windows 98 기본 배경색 */
    }
    .main-window {
      width: 90%;
      max-width: 800px;
      height: 90%;
      display: flex;
      flex-direction: column;
      border: 2px solid black;
      padding: 5px;
      background: #C0C0C0; /* Windows 98 느낌 */
    }
    .title-bar {
      display: flex;
      
      justify-content: space-between;
    }
    .window-body {
      padding: 10px;
      background: white;
    }
    #chart-container {
      width: 80%;
      
      height: 600px; /* 차트의 높이를 명확히 설정 */
      background-color: white;
      border: 2px solid black;
      padding: 10px;
      margin: 0 auto;
      z-index: 10; /* 차트가 뒤로 가지 않도록 설정 */
    }
    .stock-list-window,

    .owned-stocks {
      width: 40%;
      height: 70%;
      border: 2px solid black;
      padding: 5px;
      background-color: white;
      margin-right: 5px;
    }
    .main-content {
      display: flex;
      justify-content: space-between;
      height: 50%;
    }
    .capital,
    .controls {
      margin-top: 10px;
      text-align: center;
    }
    .capital {
      font-weight: bold;
      background-color: #C0C0C0;
      padding: 10px;
      border: 2px solid black;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .controls button,
    .controls input {
      width: 100px;
      padding: 5px;
    }

    .profit{
      color: blue;
    } 
    .loss{
      color: red;
    }
  </style>
</head>
<body>
    <div class="main-window window">
        <div class="title-bar">
          <div class="title-bar-text">연습을 위해 1분봉이아닌 3초봉으로 3초마다 값이변합니다</div>
        </div>
    
        <div class="main-content">
          <div class="stock-list-window window">
            <div class="title-bar">
              <div class="title-bar-text">현재 주식 목록</div>
            </div>
            <div class="window-body">
              <ul id="stock-list">
                <!-- 주식 목록을 여기에 동적으로 추가 -->
              </ul>
            </div>
          </div>
    
          <div class="owned-stocks window">
            <div class="title-bar">
              <div class="title-bar-text">보유한 주식</div>
            </div>
            <div class="window-body">
              <ul id="owned-stocks-list">
                <!-- 보유한 주식 목록을 여기에 동적으로 추가 -->
              </ul>
            </div>
          </div>
        </div>
    
        <div id="chart-container">
          <canvas id="stock-chart"></canvas>
        </div>
    
        <div class="capital">
          자본금: <span id="capital">1,000,000</span> 원
        </div>
    
        <div class="controls">
          <span class="cost-info" id="cost-info">비용: 0 원</span> <!-- 예상 비용 또는 수익 표시 -->
          매수량: <input type="number" id="quantity" value="1" min="1">
      
          <button id="buy-button">매수</button>
          <button id="sell-button">매도</button>
          <button id="save-button">저장</button>
        </div>
      </div>

  <script>
    let capital = 1000000; // 기본 자본금 100만원
    let selectedStockIndex = 0; // 선택된 주식의 인덱스
    let ownedStocks = {}; // 보유 주식 정보 저장 { stockName: { quantity, buyPrice } }
  
    const stockData = [
      { name: '삼성전자', price: 50000, history: [{ price: 50000 }] },
      { name: '엔디비아', price: 10000, history: [{ price: 10000 }] },
      { name: '그린컴퓨터', price: 15000, history: [{ price: 15000 }] },
      { name: '카카오', price: 1000, history: [{ price: 1000 }] }
    ];

    const stockListElement = document.getElementById('stock-list');
    const ownedStocksListElement = document.getElementById('owned-stocks-list');
    const capitalElement = document.getElementById('capital');
    const quantityInput = document.getElementById('quantity');
    const buyButton = document.getElementById('buy-button');
    const sellButton = document.getElementById('sell-button');
    const saveButton = document.getElementById('save-button');
    const ctx = document.getElementById('stock-chart').getContext('2d');
    const costInfoElement = document.getElementById('cost-info'); // 비용 정보를 표시할 요소
    
    // 매수량 입력값이 변경될 때마다 비용 정보 업데이트
    quantityInput.addEventListener('input', updateCostInfo);

    //예측매도 매수량
    function updateCostInfo() {
        const quantity = parseInt(quantityInput.value); // 입력된 매수량
        const stock = stockData[selectedStockIndex]; // 선택된 주식
        const cost = stock.price * quantity; // 매수 또는 매도 비용 계산
        costInfoElement.textContent = `비용: ${cost.toFixed(2)} 원`; // 비용 표시 업데이트
    }


    // 차트 설정
    let stockChart = new Chart(ctx, {
      type: 'line', // 라인 차트 사용
      data: {
        labels: Array(stockData[selectedStockIndex].history.length).fill(''), // X축 레이블 설정
        datasets: [ {
            label: stockData[selectedStockIndex].name, // 주식 이름
            data: stockData[selectedStockIndex].history.map(entry => entry.price),
            borderColor: 'rgb(75, 192, 192)',
            fill: false, // 차트가 선으로만 표현되도록 설정
            tension: 0.1
          }
        ]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true // Y축이 0부터 시작하도록 설정
          }
        }
      }
    });

  // URL에서 자본금과 보유 주식 상태 불러오기
  function loadStateFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // URL에서 자본금 불러오기
    if (urlParams.has('capital')) {
      capital = parseFloat(urlParams.get('capital'));
      capitalElement.textContent = capital.toFixed(2);
    }

    // URL에서 보유 주식 상태 불러오기
    if (urlParams.has('stocks')) {
      try {
        const stocksArray = JSON.parse(urlParams.get('stocks')); // 배열로 저장된 주식 정보
        ownedStocks = {}; // 빈 객체로 초기화

        // 배열 데이터를 객체로 변환하여 ownedStocks에 저장
        stocksArray.forEach(stock => {
          ownedStocks[stock.name] = {
            quantity: stock.quantity,
            buyPrice: stock.buyPrice
          };
        });

        updateOwnedStocks(); // 보유 주식 목록 업데이트
      } catch (error) {
        console.error('Error parsing stocks from URL:', error);
      }
    }
  }

    // 주식 목록 업데이트 함수
    function updateStockList() {
      stockListElement.innerHTML = ''; // 기존 주식 목록 초기화
      stockData.forEach((stock, index) => {
        const li = document.createElement('li');
        li.textContent = `${stock.name}: ${stock.price.toFixed(2)} 원`; // 주식 이름과 가격 표시
        li.addEventListener('click', () => {
          selectedStockIndex = index;
          updateChart(); // 선택된 주식의 차트 업데이트
        });
        stockListElement.appendChild(li);
      });
    }

    // 보유한 주식 목록 업데이트 함수
    function updateOwnedStocks() {
      ownedStocksListElement.innerHTML = ''; // 기존 보유 주식 목록 초기화
      Object.keys(ownedStocks).forEach(stockName => {
        const stock = stockData.find(s => s.name === stockName);
        if (stock) {
          const owned = ownedStocks[stockName];
          const currentPrice = stock.price;
          const totalCost = owned.quantity * owned.buyPrice;
          const currentValue = owned.quantity * currentPrice;
          const profitOrLoss = currentValue - totalCost; // 이익/손실 계산
          const profitOrLossClass = profitOrLoss >= 0 ? 'profit' : 'loss'; // 이익이면 파란색, 손실이면 빨간색
  
          const li = document.createElement('li');
          li.innerHTML = `${stockName}: ${owned.quantity}주, 
                          현재가: ${currentPrice.toFixed(2)} 원 
                          <span class="${profitOrLossClass}">
                            (${profitOrLoss >= 0 ? '+' : ''}${profitOrLoss.toFixed(2)} 원)
                          </span>`;
          ownedStocksListElement.appendChild(li);
        }
      });
    }

// 차트 업데이트 함수
function updateChart() {
  const stock = stockData[selectedStockIndex];
  let today = new Date();

  // 차트의 데이터셋 업데이트 (가격)
  stockChart.data.datasets[0].label = stock.name;
  stockChart.data.datasets[0].data = stock.history.map(entry => entry.price);

  // 차트 라벨 업데이트 (현재 시간 추가)
  const newLabel = today.toLocaleTimeString('en-GB', { 
    hour: '2-digit', 
    minute: '2-digit', 
    second: '2-digit' 
  });

  // 기록이 10개를 넘으면 오래된 기록과 라벨 삭제
  if (stockChart.data.labels.length >= 10) {
    stockChart.data.labels.shift(); // 오래된 라벨 삭제
  }
  
  stockChart.data.labels.push(newLabel); // 새 라벨 추가
  stockChart.update(); // 차트 업데이트
}

// 주식 가격 업데이트 함수
function updatePrices() {
  stockData.forEach(stock => {
    const maxChange = stock.price * 0.3;
    const change = (Math.random() * (2 * maxChange)) - maxChange;
    stock.price = Math.max(0, stock.price + parseInt(change));

    // 가격 기록(history)에 새로운 가격 추가
    stock.history.push({ price: stock.price });

    // 기록이 10개를 넘으면 오래된 기록 삭제
    if (stock.history.length > 10) {
      stock.history.shift(); // 오래된 기록 삭제
    }
  });

  updateStockList(); // 주식 목록 업데이트
  updateOwnedStocks(); // 보유 주식 목록 업데이트
  updateChart(); // 차트 업데이트
}



    // 매수 함수
    function buyStock() {
      const quantity = parseInt(quantityInput.value); // 매수량 가져오기
      const stock = stockData[selectedStockIndex];
      const cost = stock.price * quantity; // 총 매수 비용 계산
      if (capital >= cost) {
        capital -= cost; // 자본금에서 매수 비용 차감
        capitalElement.textContent = capital.toFixed(2);
        if (ownedStocks[stock.name]) {
          const totalQuantity = ownedStocks[stock.name].quantity + quantity;
          ownedStocks[stock.name].buyPrice = 
            ((ownedStocks[stock.name].buyPrice * ownedStocks[stock.name].quantity) + cost) / totalQuantity; // 평균 매입가 재계산
          ownedStocks[stock.name].quantity = totalQuantity;
        } else {
          ownedStocks[stock.name] = { quantity, buyPrice: stock.price }; // 새로운 주식 추가
        }
        alert(`${stock.name} 주식을 ${quantity}주 매수했습니다. 현재 가격: ${stock.price.toFixed(2)} 원`);
        updateOwnedStocks();
      } else {
        alert('자본금이 부족합니다.');
      }
    }

    // 매도 함수
    function sellStock() {
      const quantity = parseInt(quantityInput.value); // 매도할 주식 수량
      const stock = stockData[selectedStockIndex];
      if (ownedStocks[stock.name] && ownedStocks[stock.name].quantity >= quantity) {
        const profit = stock.price * quantity; // 매도 후 이익 계산
        capital += profit; // 자본금에 매도 이익 추가
        ownedStocks[stock.name].quantity -= quantity; // 보유 주식 수량 감소
        if (ownedStocks[stock.name].quantity === 0) {
          delete ownedStocks[stock.name]; // 주식 수량이 0이 되면 삭제
        }
        capitalElement.textContent = capital.toFixed(2);
        alert(`${stock.name} 주식을 ${quantity}주 매도했습니다. 현재 가격: ${stock.price.toFixed(2)} 원`);
        updateOwnedStocks();
      } else {
        alert('보유한 주식이 부족합니다.');
      }
    }

      // 상태 저장 함수
    function saveState() {
      // 보유 주식 정보가 제대로 저장되어 있는지 확인
      const stocksOwned = Object.keys(ownedStocks).map(stockName => {
        const stock = ownedStocks[stockName];
        return {
          name: stockName,
          quantity: stock.quantity,
          buyPrice: stock.buyPrice
        };
      });

      // 자본금 및 보유 주식 상태 저장을 위해 URL 파라미터로 변환
      const queryParams = new URLSearchParams({
        capital: capital.toFixed(2), // 자본금
        stocks: JSON.stringify(stocksOwned) // 보유 주식 데이터
      });

      // 페이지를 새로고침하지 않고 URL을 업데이트
      history.replaceState(null, '', '?' + queryParams.toString());
    }

    buyButton.addEventListener('click', buyStock);
    sellButton.addEventListener('click', sellStock);
    saveButton.addEventListener('click', saveState);

    function init() {
      loadStateFromURL(); // 페이지 시작 시 URL에서 자본금과 주식 상태 불러오기
      updateStockList();
      updateOwnedStocks(); // 불러온 주식 상태를 화면에 표시
      setInterval(updatePrices, 3000); // 3초마다 주식 가격 변동
    }

    init();
  </script>

</body>
</html>
